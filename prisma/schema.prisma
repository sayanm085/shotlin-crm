// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Status {
  NOT_STARTED
  PENDING_CLIENT
  PENDING_VERIFICATION
  IN_PROGRESS
  COMPLETED
  FAILED
  BLOCKED
}

enum ComplianceStatus {
  NOT_CREATED
  PENDING
  APPROVED
}

enum Responsibility {
  CLIENT
  COMPANY
}

enum CompanyType {
  INDIVIDUAL
  FIRM
  PVT_LTD
}

enum PublishingStatus {
  NOT_SUBMITTED
  IN_REVIEW
  PRODUCTION
}

enum UserRole {
  SUPER_ADMIN
  TEAM_MEMBER
  CLIENT
  MEMBER
}

// ============================================
// AUTH MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(TEAM_MEMBER)
  isActive      Boolean   @default(true)
  clientId      String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client         Client?   @relation(fields: [clientId], references: [id])
  accounts       Account[]
  sessions       Session[]
  createdClients Client[]  @relation("CreatedClients")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CORE BUSINESS MODELS
// ============================================

enum OnboardingStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

model Client {
  id               String      @id @default(uuid())
  legalName        String
  panNumber        String      @unique
  companyType      CompanyType
  email            String      @unique
  phone            String?
  address          String?
  identityVerified Boolean     @default(false)
  createdById      String?     // User ID who created this client
  
  // Workflow tracking fields
  onboardingStatus OnboardingStatus @default(DRAFT)
  websiteUrl       String?
  websiteVerified  Boolean     @default(false)
  
  // Website parallel work
  websiteDesignDone Boolean @default(false)
  websiteDevDone Boolean @default(false)
  websiteSearchConsoleDone Boolean @default(false)
  
  // App development parallel work
  appUiDone Boolean @default(false)
  appDevDone Boolean @default(false)
  appTestingDone Boolean @default(false)
  
  // App upload parallel work
  uploadAssetsDone Boolean @default(false)
  assetsUrl        String?
  uploadScreenshotsDone Boolean @default(false)
  uploadApkDone Boolean @default(false)
  apkUrl           String?
  privacyPolicyDone Boolean @default(false)  // Privacy policy page created
  privacyPolicyUrl String?
  
  // Publishing status
  publishingStatus PublishingStatus @default(NOT_SUBMITTED)
  
  appApproved      Boolean     @default(false)
  published        Boolean     @default(false)
  liveUrl          String?
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  user                 User?
  createdBy            User?               @relation("CreatedClients", fields: [createdById], references: [id])
  complianceDocuments  ComplianceDocument?
  websiteTasks         WebsiteTask[]
  playConsoleStatus    PlayConsoleStatus?
  appDevelopmentTasks  AppDevelopmentTask[]
  playStoreAssets      PlayStoreAsset[]
  submissionReview     SubmissionReview?
  paymentMilestones    PaymentMilestone[]
  auditLogs            AuditLog[]
  organizationCost     OrganizationCost?
}

model ComplianceDocument {
  id              String           @id @default(uuid())
  clientId        String           @unique
  msmeStatus      ComplianceStatus @default(NOT_CREATED)
  msmeDocumentUrl String?
  msmeRegistrationNumber String?
  dunsStatus      ComplianceStatus @default(NOT_CREATED)
  dunsDocumentUrl String?
  dunsNumber      String?
  lastVerifiedAt  DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model WebsiteTask {
  id             String         @id @default(uuid())
  clientId       String
  taskName       String
  description    String?
  status         Status         @default(NOT_STARTED)
  dependencyTask String?
  owner          Responsibility @default(COMPANY)
  blockedReason  String?
  dueDate        DateTime?
  completedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, taskName])
}

model PlayConsoleStatus {
  id                         String   @id @default(uuid())
  clientId                   String   @unique
  consoleEmail               String?
  accountCreated             Boolean  @default(false)
  accountPaid                Boolean  @default(false)  // $25 payment done
  identityVerificationStatus Boolean  @default(false)
  companyVerificationStatus  Boolean  @default(false)
  developerInviteEmail       String?  // Email for developer full access
  developerInvited           Boolean  @default(false)
  paymentProfileStatus       Boolean  @default(false)
  consoleReady               Boolean  @default(false)
  blockedReason              String?
  
  // Account Sale tracking
  accountSaleComplete        Boolean  @default(false)
  accountSaleAmount          Float?   // Amount buyer paid
  
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model AppDevelopmentTask {
  id             String         @id @default(uuid())
  clientId       String
  moduleName     String
  description    String?
  status         Status         @default(NOT_STARTED)
  dependency     String?
  responsibility Responsibility @default(COMPANY)
  blockedReason  String?
  dueDate        DateTime?
  completedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, moduleName])
}

enum AssetType {
  ICON
  SHORT_DESCRIPTION
  LONG_DESCRIPTION
  FEATURE_GRAPHIC
  SCREENSHOT
  PREVIEW_VIDEO
}

model PlayStoreAsset {
  id             String    @id @default(uuid())
  clientId       String
  assetType      AssetType
  status         Status    @default(NOT_STARTED)
  validationRule String
  assetUrl       String?
  validated      Boolean   @default(false)
  validationNote String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, assetType])
}

model SubmissionReview {
  id                  String          @id @default(uuid())
  clientId            String          @unique
  uploaded            Boolean         @default(false)
  uploadedAt          DateTime?
  internalTesting     Boolean         @default(false)
  internalTestingAt   DateTime?
  productionSubmitted Boolean         @default(false)
  productionSubmittedAt DateTime?
  reviewStatus        Status          @default(NOT_STARTED)
  published           Boolean         @default(false)
  publishedAt         DateTime?
  liveUrl             String?
  rejectionReason     String?
  rejectionFault      Responsibility?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model PaymentMilestone {
  id                 String   @id @default(uuid())
  clientId           String
  milestoneName      String
  amount             Decimal  @db.Decimal(10, 2)
  eligibleForPayment Boolean  @default(false)
  eligibleAt         DateTime?
  released           Boolean  @default(false)
  releasedAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, milestoneName])
}

model AuditLog {
  id        String   @id @default(uuid())
  clientId  String
  tableName String
  recordId  String
  action    String   // CREATE, UPDATE, DELETE
  oldValue  Json?
  newValue  Json?
  changedBy String
  changedAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([tableName])
  @@index([changedAt])
}

// Organization costs/liability tracking (expenses paid by company, not client)
model OrganizationCost {
  id             String   @id @default(uuid())
  clientId       String   @unique
  domainCost     Float    @default(0)   // Domain purchase cost
  playConsoleFee Float    @default(25)  // Google $25 registration fee
  otherCosts     Float    @default(0)   // Any other expenses
  costNotes      String?                // Notes about costs
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}
